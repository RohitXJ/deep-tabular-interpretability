{% extends "base.html" %}

{% block content %}
    <h3>Step 2: Select Model</h3>
    <p>Dataset: <strong>{{ session.get('filename', 'N/A') }}</strong></p>
    <form method="POST" novalidate>
        {{ form.hidden_tag() }} {# CSRF protection #}

        <p>
            {{ form.prediction_type.label }}<br>
            {{ form.prediction_type() }}
        </p>

        <p>
            {{ form.model.label }}<br>
            {{ form.model() }}
        </p>

        <div id="dl_options" style="display: none;">
            <p>
                {{ form.hyperparameter_mode.label }}<br>
                {{ form.hyperparameter_mode() }}
            </p>

            <div id="manual_hyperparameters" style="display: none;">
                <h4>Hyperparameters</h4>
                <div id="hyperparameter-fields"></div>
            </div>
        </div>

        <p>{{ form.submit() }}</p>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const predictionTypeSelect = document.getElementById('prediction_type');
            const modelSelect = document.getElementById('model');
            const dlOptionsDiv = document.getElementById('dl_options');
            const hyperparameterModeSelect = document.getElementById('hyperparameter_mode');
            const manualHyperparametersDiv = document.getElementById('manual_hyperparameters');
            const hyperparameterFieldsDiv = document.getElementById('hyperparameter-fields');
            const dlModels = {{ dl_models | tojson }};
            const defaultHyperparameters = {{ default_hyperparameters | tojson }};

            function updateModelAndHyperparameters() {
                const selectedModel = modelSelect.value;
                if (dlModels.includes(selectedModel)) {
                    dlOptionsDiv.style.display = 'block';
                    if (hyperparameterModeSelect.value === 'Manual') {
                        manualHyperparametersDiv.style.display = 'block';
                        hyperparameterFieldsDiv.innerHTML = '';
                        const params = defaultHyperparameters[selectedModel];
                        for (const key in params) {
                            const label = document.createElement('label');
                            label.textContent = key;
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.name = 'hyperparam_' + key;
                            input.value = params[key];
                            hyperparameterFieldsDiv.appendChild(label);
                            hyperparameterFieldsDiv.appendChild(input);
                            hyperparameterFieldsDiv.appendChild(document.createElement('br'));
                        }
                    } else {
                        manualHyperparametersDiv.style.display = 'none';
                    }
                } else {
                    dlOptionsDiv.style.display = 'none';
                    manualHyperparametersDiv.style.display = 'none';
                }
            }

            predictionTypeSelect.addEventListener('change', function () {
                const predictionType = this.value;
                fetch(`/models/${predictionType}`)
                    .then(response => response.json())
                    .then(data => {
                        modelSelect.innerHTML = ''; // Clear existing options
                        data.models.forEach(model => {
                            const option = document.createElement('option');
                            option.value = model.value;
                            option.textContent = model.text;
                            modelSelect.appendChild(option);
                        });
                        updateModelAndHyperparameters(); // Update after populating
                    });
            });

            modelSelect.addEventListener('change', updateModelAndHyperparameters);
            hyperparameterModeSelect.addEventListener('change', updateModelAndHyperparameters);

            // Initial update on page load
            updateModelAndHyperparameters();
        });
    </script>
{% endblock %}
